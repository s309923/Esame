# Film Manager Service - Instructions

## Overview
This server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project.  By using the [OpenAPI-Spec](https://github.com/OAI/OpenAPI-Specification) from a remote server, you can easily generate a server stub.

## Design choice
To implement the new functionality I decided to introduce a new delegation table. When a reviewer delegates a review to a new user we add a new row in this table which contains the same fields as the review and in addition the id of the delegate. When I want to update a review if I am a reviewer and I have not delegated my review to anyone the data will be changed in the review table, but if I am a delegate I will make changes in the delegation table. For both tables the possibility of partial changes has been introduced so I have modified the schemas to make it possible to pass an incomplete review.

Now we will see the modified API and the json objects to be passed to it:

### To get all the film review:
#### app.get('/api/films/public/:filmId/reviews', reviewController.getFilmReviews);

```json
{
    "filmId" : 4
}
```
The system returns all the review for this film. If there is a delegation, the delegate's review is returned with its information, otherwise the reviewer's review is returned.

### To get a single review:
#### app.get('/api/films/public/:filmId/reviews/:reviewerId', reviewController.getSingleReview);
```json
{
    "filmId" : 4, 
    "reviewerId" : 1
}
```
The system returns the requested review for this film. If there is a delegation, the delegate's review is returned, otherwise the reviewer's review is returned.

### To update a review:
#### app.put('/api/films/public/:filmId/reviews/:reviewerId', isLoggedIn, validate({ body: reviewSchema }), reviewController.updateSingleReview);
```json
{
    "filmId" : 4, //mandatory
    "reviewerId" : 1, //mandatory
    "completed": true, //mandatory
    "reviewDate" : "2024-06-02",
    "rating" : 7,
    "review" : "Nice film"
}
```
This update will be made in the Review table if I am the reviewer of the film or in the Delegation table if I have been delegated by the reviewer to review the film. Being able to make a partial change each time the last three fields of the JSON are not mandatory instead filmId, reviewerId and completed are mandatory. The completed can only be set to true when the last three fields are present in the db. If passed as true when one of the fields is still empty, it is set to false automatically

### To delete a review:
#### app.delete('/api/films/public/:filmId/reviews/:reviewerId', isLoggedIn, reviewController.deleteSingleReview);
```json
{
    "filmId" : 4, 
    "reviewerId" : 1
}
```
This operation is only done if the review has not been completed or if, having been delegated to a new user, the delegation has not been completed in turn. If the delegation is also incomplete the delete operation deletes both. In the server, these two cascading deletes have been handled with a database transaction to deal with the case that one of them fails.

### To delegate a review:
#### app.post('/api/films/public/:filmId/reviews/:reviewerId/delegations', isLoggedIn, delegationController.issueDelegation);
```json
{
    "filmId" : 4, 
    "delegatedId": 5
}
```
You may not delegate the review to another user if they are the owner of the film, if they are already a reviewer of the same film or to themselves. Once the review has been delegated cannot be delegate to another user, only the delegate can modify it and cannot delegate it in turn.

### To delete a delegation:
#### app.delete('/api/films/public/:filmId/reviews/:reviewerId/delegations/:delegatedId', isLoggedIn, delegationController.deleteDelegation);
```json
{
    "filmId" : 4, 
    "reviewerId" : 1,
    "delegatedId": 5
}
```
This delegation is only deleted if it has not yet been completed

## Running the server

To install dependencies and to launch the server:
prova_esame\REST APIs Implementation> npm start

To test all the new functionalities, I initialised the db so that all the 
APIs of the Postman collection (in the API design folder) can be executed in order

To view the Swagger UI interface:
open http://localhost:3001/docs

Database can be visualised by means of https://sqlitebrowser.org/ by importing:
prova_esame\REST APIs Implementation\database\databaseV1.db

To test the app, use the following credentials:
- User #1
-- Username: user.dsp@polito.it
-- Password: password
- User #2
-- Username: frank.stein@polito.it
-- Password: shelley97
- User #3
-- Username: karen.makise@polito.it
-- Password: fg204v213
- User #4
-- Username: rene.regeay@polito.it
-- Password: historia
- User #5
-- Username: beatrice.golden@polito.it
-- Password: seagulls
- User #6
-- Username: arthur.pendragon@polito.it
-- Password: holygrail


To set the number of items in each page of the pagination mechanism, change the OFFSET variable in:
prova_esame\REST APIs Implementation\utils\constants.js

